<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Historical Data Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a2e; color: #ffffff; }
        .card { background-color: #16213e; border: 1px solid #0f3460; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üéØ Historical Data Integration Test</h1>
        <p class="text-muted">Testing if backtesting controls get populated with historical data</p>

        <!-- Test Section 1: Data Discovery Display -->
        <div class="test-section">
            <h3>üìä Data Discovery</h3>
            <div class="row">
                <div class="col-md-8">
                    <div class="text-muted small mb-1">Your Downloaded Historical Data</div>
                    <div id="availableDataSets" class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary">
                            <i class="bi bi-search"></i> Scanning...
                        </span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-info me-1" id="totalDataSets">0 datasets</span>
                    <span class="badge bg-success" id="totalRecords">0 records</span>
                </div>
            </div>
        </div>

        <!-- Test Section 2: Backtesting Controls -->
        <div class="test-section">
            <h3>üéØ Backtesting Controls</h3>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Trading Pair</label>
                    <select class="form-select" id="backtestPair">
                        <option value="">-- Loading... --</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Timeframe</label>
                    <select class="form-select" id="backtestTimeframe">
                        <option value="">-- Loading... --</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="p-3 border rounded">
                        <div id="backtestDataStatus">
                            <i class="bi bi-hourglass-split"></i> Initializing...
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <button class="btn btn-warning w-100" id="runBacktestBtn" disabled>
                        <i class="bi bi-gear"></i> Initializing...
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Section 3: Debug Info -->
        <div class="test-section">
            <h3>üîç Debug Information</h3>
            <div id="debugInfo">
                <div class="text-muted">Loading debug information...</div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-section">
            <h3>‚öôÔ∏è Test Controls</h3>
            <div class="row g-2">
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="testDirectDiscovery()">
                        <i class="bi bi-search"></i> Test Data Discovery
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-success" onclick="forcePopulateControls()">
                        <i class="bi bi-arrow-clockwise"></i> Force Populate
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-info" onclick="checkElements()">
                        <i class="bi bi-list-check"></i> Check Elements
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üéØ Test page loaded');

        // Test data (matches your actual database)
        const testData = [
            {
                symbol: 'BTCUSDT',
                timeframe: '15m', 
                record_count: 7998,
                date_range: '2025-07-20 to 2025-10-11',
                duration_days: 83
            }
        ];

        // Test direct discovery
        function testDirectDiscovery() {
            console.log('üß™ Testing direct discovery...');
            updateDebugInfo('Testing data discovery...');
            
            setTimeout(() => {
                populateDataDisplay(testData);
                populateBacktestControls(testData);
                updateDebugInfo('‚úÖ Direct discovery test completed');
            }, 1000);
        }

        // Populate data display
        function populateDataDisplay(datasets) {
            console.log('üìä Populating data display with', datasets.length, 'datasets');
            
            const availableDataSets = document.getElementById('availableDataSets');
            const totalDataSets = document.getElementById('totalDataSets');
            const totalRecords = document.getElementById('totalRecords');
            
            if (datasets.length > 0) {
                const totalRecs = datasets.reduce((sum, d) => sum + d.record_count, 0);
                
                totalDataSets.textContent = `${datasets.length} datasets`;
                totalRecords.textContent = `${totalRecs.toLocaleString()} records`;
                
                availableDataSets.innerHTML = '';
                datasets.forEach(dataset => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-success me-2 mb-1';
                    badge.innerHTML = `
                        <i class="bi bi-database-fill"></i> 
                        ${dataset.symbol} ${dataset.timeframe} 
                        <small>(${dataset.record_count.toLocaleString()})</small>
                    `;
                    availableDataSets.appendChild(badge);
                });
            }
        }

        // Populate backtest controls
        function populateBacktestControls(datasets) {
            console.log('üéØ Populating backtest controls...');
            
            const backtestPair = document.getElementById('backtestPair');
            const backtestTimeframe = document.getElementById('backtestTimeframe');
            const backtestDataStatus = document.getElementById('backtestDataStatus');
            const runBtn = document.getElementById('runBacktestBtn');
            
            if (!backtestPair || !backtestTimeframe) {
                console.error('‚ùå Controls not found!');
                return;
            }
            
            // Get unique values
            const uniquePairs = [...new Set(datasets.map(d => d.symbol))];
            const uniqueTimeframes = [...new Set(datasets.map(d => d.timeframe))];
            
            // Populate pairs
            backtestPair.innerHTML = '<option value="">-- Select Trading Pair --</option>';
            uniquePairs.forEach(pair => {
                const option = document.createElement('option');
                option.value = pair;
                option.textContent = pair;
                backtestPair.appendChild(option);
            });
            
            // Populate timeframes
            backtestTimeframe.innerHTML = '<option value="">-- Select Timeframe --</option>';
            uniqueTimeframes.forEach(tf => {
                const option = document.createElement('option');
                option.value = tf;
                option.textContent = tf === '15m' ? '15 Minutes' : tf;
                backtestTimeframe.appendChild(option);
            });
            
            // Set defaults
            if (datasets.length > 0) {
                backtestPair.value = datasets[0].symbol;
                backtestTimeframe.value = datasets[0].timeframe;
                
                backtestDataStatus.innerHTML = `
                    <i class="bi bi-check-circle text-success"></i> 
                    ‚úÖ Ready: ${datasets[0].record_count.toLocaleString()} records (${datasets[0].date_range})
                `;
                
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="bi bi-play-fill"></i> Run Backtest';
            }
            
            console.log('‚úÖ Backtest controls populated successfully');
        }

        // Force populate (simulates what should happen in main dashboard)
        function forcePopulateControls() {
            console.log('üîÑ Force populating controls...');
            updateDebugInfo('Force populating with test data...');
            
            populateDataDisplay(testData);
            populateBacktestControls(testData);
            updateDebugInfo('‚úÖ Force populate completed - this is what should happen in your main dashboard!');
        }

        // Check elements
        function checkElements() {
            const elements = ['backtestPair', 'backtestTimeframe', 'backtestDataStatus', 'runBacktestBtn'];
            let found = [];
            let missing = [];
            
            elements.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    found.push(id);
                } else {
                    missing.push(id);
                }
            });
            
            updateDebugInfo(`Found: ${found.join(', ')} | Missing: ${missing.join(', ') || 'None'}`);
        }

        // Update debug info
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML = `<div class="small text-info">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Test page DOM loaded');
            updateDebugInfo('Test page initialized - click buttons to test functionality');
            
            // Auto-test after 2 seconds
            setTimeout(() => {
                console.log('üöÄ Auto-running test...');
                forcePopulateControls();
            }, 2000);
        });

    </script>
</body>
</html>