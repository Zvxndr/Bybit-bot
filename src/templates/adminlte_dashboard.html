<!DOCTYPE html>
<html lang="en">
<!-- 🔍 CLEAN TEMPLATE: AdminLTE Dashboard - Syntax Error Free Version -->
<!-- 🎯 NAVIGATION STATUS: Simple Bulletproof JavaScript System -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Professional Trading Dashboard | Open Alpha System</title>

    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    
    <style>
        .content-section {
            padding: 20px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .status-live { background: #10b981; color: white; }
        .status-paper { background: #f59e0b; color: white; }
        .status-inactive { background: #6b7280; color: white; }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-dark">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" role="button"><i class="fas fa-bars"></i></a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <span class="navbar-text">🚀 Open Alpha System</span>
            </li>
        </ul>
    </nav>

    <!-- Main Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" role="menu" data-accordion="false">
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="overview" onclick="switchSection('overview'); return false;">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>System Overview</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="ai-lab" onclick="switchSection('ai-lab'); return false;">
                            <i class="nav-icon fas fa-flask"></i>
                            <p>AI Strategy Lab</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="trading" onclick="switchSection('trading'); return false;">
                            <i class="nav-icon fas fa-rocket"></i>
                            <p>Live Trading Engine</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="portfolio" onclick="switchSection('portfolio'); return false;">
                            <i class="nav-icon fas fa-briefcase"></i>
                            <p>Portfolio Management</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="analytics" onclick="switchSection('analytics'); return false;">
                            <i class="nav-icon fas fa-chart-line"></i>
                            <p>Performance Analytics</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="risk" onclick="switchSection('risk'); return false;">
                            <i class="nav-icon fas fa-shield-alt"></i>
                            <p>Risk Management</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="settings" onclick="switchSection('settings'); return false;">
                            <i class="nav-icon fas fa-cogs"></i>
                            <p>System Settings</p>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" data-section="debug" onclick="switchSection('debug'); return false;">
                            <i class="nav-icon fas fa-bug"></i>
                            <p>Debug Console</p>
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        
        <!-- System Overview Section -->
        <div class="content-section" id="section-overview">
            <div class="content-header">
                <h1>🎯 System Overview</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>🚀 Open Alpha Trading System</h3>
                    <p><span class="status-indicator status-paper">CONNECTING...</span></p>
                    <p>Professional algorithmic trading platform with real-time market analysis.</p>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="info-box bg-success">
                                <span class="info-box-icon"><i class="fas fa-chart-line"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Active Strategies</span>
                                    <span class="info-box-number" data-metric="strategies">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-info">
                                <span class="info-box-icon"><i class="fas fa-coins"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Portfolio Value</span>
                                    <span class="info-box-number" data-metric="portfolio">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-warning">
                                <span class="info-box-icon"><i class="fas fa-robot"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Active Positions</span>
                                    <span class="info-box-number" data-metric="positions">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-danger">
                                <span class="info-box-icon"><i class="fas fa-chart-bar"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Daily P&L</span>
                                    <span class="info-box-number" data-metric="pnl">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">System Metrics</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <p><strong><span data-metric="cpu">CPU: Loading...</span></strong></p>
                                        </div>
                                        <div class="col-md-3">
                                            <p><strong><span data-metric="memory">Memory: Loading...</span></strong></p>
                                        </div>
                                        <div class="col-md-3">
                                            <p><strong><span data-metric="disk">Disk: Loading...</span></strong></p>
                                        </div>
                                        <div class="col-md-3">
                                            <p><strong>Status: <span class="status-indicator status-paper">CONNECTING</span></strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- AI Strategy Lab Section -->
        <div class="content-section" id="section-ai-lab" style="display: none;">
            <div class="content-header">
                <h1>🧪 AI Strategy Lab</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Machine Learning Engine</h3>
                    <p><span class="status-indicator status-paper">DEVELOPMENT</span></p>
                    <p>AI strategy development and backtesting environment.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Strategy Development</h3>
                                </div>
                                <div class="card-body">
                                    <p>Status: In Development</p>
                                    <p>Framework: Available for ML integration</p>
                                    <p>Mode: Paper trading and backtesting</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Available Tools</h3>
                                </div>
                                <div class="card-body">
                                    <p>• Historical data analysis</p>
                                    <p>• Strategy backtesting</p>
                                    <p>• Risk assessment framework</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Live Trading Section -->
        <div class="content-section" id="section-trading" style="display: none;">
            <div class="content-header">
                <h1>🚀 Live Trading Engine</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Automated Trading System</h3>
                    <p><span class="status-indicator status-live">TRADING LIVE</span></p>
                    <p>Real-time algorithmic trading with advanced risk management.</p>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Active Positions</h3>
                                </div>
                                <div class="card-body">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Side</th>
                                                <th>Size</th>
                                                <th>Entry</th>
                                                <th>Current</th>
                                                <th>PnL</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Loading positions...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Portfolio Management Section -->
        <div class="content-section" id="section-portfolio" style="display: none;">
            <div class="content-header">
                <h1>💼 Portfolio Management</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Portfolio Overview</h3>
                    <p>Comprehensive portfolio tracking and management tools.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Asset Allocation</h3>
                                </div>
                                <div class="card-body">
                                    <p>Portfolio allocation will be displayed when positions are active.</p>
                                    <p class="text-muted">Current mode: Paper trading / Development</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Performance Metrics</h3>
                                </div>
                                <div class="card-body">
                                    <p>Metrics will be calculated from actual trading data.</p>
                                    <p class="text-muted">Historical backtesting available in AI Lab.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Performance Analytics Section -->
        <div class="content-section" id="section-analytics" style="display: none;">
            <div class="content-header">
                <h1>📊 Performance Analytics</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Trading Analytics</h3>
                    <p>Detailed performance metrics and trading statistics.</p>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Key Metrics</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <p class="text-muted">Performance analytics will be generated from actual trading data.</p>
                                            <p>Current mode: Paper trading and historical backtesting</p>
                                            <p>Start trading to generate real performance metrics.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Risk Management Section -->
        <div class="content-section" id="section-risk" style="display: none;">
            <div class="content-header">
                <h1>🛡️ Risk Management</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Risk Controls</h3>
                    <p><span class="status-indicator status-live">MONITORING</span></p>
                    <p>Advanced risk management and position sizing algorithms.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Risk Limits</h3>
                                </div>
                                <div class="card-body">
                                    <p>Risk limits will be displayed when configured.</p>
                                    <p class="text-muted">Current mode: Paper trading</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Current Exposure</h3>
                                </div>
                                <div class="card-body">
                                    <p>No active positions</p>
                                    <p class="text-muted">Exposure metrics available when trading</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- System Settings Section -->
        <div class="content-section" id="section-settings" style="display: none;">
            <div class="content-header">
                <h1>⚙️ System Settings</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>Configuration</h3>
                    <p>System settings and trading parameters.</p>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Trading Settings</h3>
                                </div>
                                <div class="card-body">
                                    <form>
                                        <div class="form-group">
                                            <label>Max Position Size (%)</label>
                                            <input type="number" class="form-control" value="5" min="1" max="10">
                                        </div>
                                        <div class="form-group">
                                            <label>Risk Level</label>
                                            <select class="form-control">
                                                <option>Conservative</option>
                                                <option selected>Moderate</option>
                                                <option>Aggressive</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Trading Mode</label>
                                            <select class="form-control">
                                                <option>Paper Trading</option>
                                                <option selected>Live Trading</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Debug Console Section -->
        <div class="content-section" id="section-debug" style="display: none;">
            <div class="content-header">
                <h1>🐛 Debug Console</h1>
            </div>
            <section class="content">
                <div class="dashboard-card">
                    <h3>System Debug Information</h3>
                    <p><span class="status-indicator status-paper">DEBUG MODE</span></p>
                    <p>Current system is in paper trading mode. All trading is simulated.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">🚨 Emergency Controls</h3>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group-vertical w-100" role="group">
                                        <button type="button" class="btn btn-danger mb-2" onclick="emergencyStop()">
                                            <i class="fas fa-stop"></i> EMERGENCY STOP
                                        </button>
                                        <button type="button" class="btn btn-warning mb-2" onclick="pauseTrading()">
                                            <i class="fas fa-pause"></i> Pause Trading
                                        </button>
                                        <button type="button" class="btn btn-success mb-2" onclick="resumeTrading()">
                                            <i class="fas fa-play"></i> Resume Trading
                                        </button>
                                        <button type="button" class="btn btn-info" onclick="refreshData()">
                                            <i class="fas fa-sync"></i> Refresh Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">System Log</h3>
                                </div>
                                <div class="card-body">
                                    <div id="debug-log" style="background: #000; color: #0f0; padding: 10px; font-family: monospace; max-height: 300px; overflow-y: auto;">
                                        <div>🔧 SYSTEM: Initializing...</div>
                                        <div>✅ NAVIGATION: System ready</div>
                                        <div>🔌 API: Connecting to backend...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

<!-- BULLETPROOF NAVIGATION SYSTEM -->
<script>
console.log('🔧 CLEAN NAVIGATION: Loading...');

// Simple, syntax-error-free navigation
function switchSection(sectionId) {
    console.log('🎯 NAVIGATION: Switching to ' + sectionId);
    
    // Log to debug console
    addDebugLog('🎯 NAVIGATION: Switching to ' + sectionId);
    
    try {
        // Hide all sections
        var sections = document.querySelectorAll('.content-section');
        for (var i = 0; i < sections.length; i++) {
            sections[i].style.display = 'none';
        }
        
        // Show target section
        var targetSection = document.getElementById('section-' + sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            console.log('✅ SUCCESS: Section ' + sectionId + ' is now visible');
            addDebugLog('✅ SUCCESS: Section ' + sectionId + ' displayed');
        } else {
            console.error('❌ ERROR: Section not found: ' + sectionId);
            addDebugLog('❌ ERROR: Section not found: ' + sectionId);
        }
        
        // Update navigation
        updateNavigation(sectionId);
        
    } catch (error) {
        console.error('❌ NAVIGATION ERROR:', error);
        addDebugLog('❌ ERROR: ' + error.message);
    }
}

// Update navigation state
function updateNavigation(activeSection) {
    try {
        // Remove active class from all nav links
        var navLinks = document.querySelectorAll('.nav-link');
        for (var i = 0; i < navLinks.length; i++) {
            navLinks[i].classList.remove('active');
        }
        
        // Add active class to current nav link
        var activeLink = document.querySelector('[data-section="' + activeSection + '"]');
        if (activeLink) {
            activeLink.classList.add('active');
            console.log('✅ NAV: Updated active state for ' + activeSection);
        }
    } catch (error) {
        console.error('❌ NAV UPDATE ERROR:', error);
    }
}

// Add debug log entry
function addDebugLog(message) {
    try {
        var debugLog = document.getElementById('debug-log');
        if (debugLog) {
            var timestamp = new Date().toLocaleTimeString();
            var logEntry = document.createElement('div');
            logEntry.textContent = timestamp + ' - ' + message;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
    } catch (error) {
        console.error('Debug log error:', error);
    }
}

// Consolidated initialization - FIRST PART ONLY (second part below)

// ===== BACKEND API INTEGRATION =====
console.log('🔌 API INTEGRATION: Loading...');

// Global data storage
var apiData = {
    system: {},
    positions: [],
    balance: {},
    lastUpdate: null
};

// Enhanced API call function with better error handling
function apiCall(endpoint, callback, errorCallback) {
    addDebugLog('🔄 API CALL: Requesting ' + endpoint);
    
    fetch('/api/' + endpoint)
        .then(response => {
            addDebugLog('📡 API RESPONSE: ' + endpoint + ' - Status: ' + response.status);
            
            if (!response.ok) {
                return response.text().then(text => {
                    addDebugLog('❌ HTTP ERROR: ' + response.status + ' - Response: ' + text.substring(0, 100));
                    throw new Error('HTTP ' + response.status + ' - Server Error');
                });
            }
            
            // Try to parse JSON with better error handling
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    addDebugLog('❌ JSON PARSE ERROR: ' + text.substring(0, 50) + '...');
                    throw new Error('Invalid JSON response from server');
                }
            });
        })
        .then(data => {
            addDebugLog('✅ API SUCCESS: ' + endpoint + ' - Data received');
            if (callback) callback(data);
        })
        .catch(error => {
            addDebugLog('❌ API ERROR: ' + endpoint + ' - ' + error.message);
            console.error('API Error Details:', {
                endpoint: endpoint,
                error: error.message,
                timestamp: new Date().toISOString()
            });
            
            // Handle specific endpoint failures with fallbacks
            if (endpoint === 'status') {
                addDebugLog('🔄 FALLBACK: Using offline mode for status');
                var fallbackStatus = {
                    trading_bot: {
                        status: "offline",
                        trading_mode: "Paper Trading",
                        debug_mode: true,
                        strategies_active: 0,
                        positions: 0,
                        balance: "Offline",
                        daily_pnl: "N/A"
                    },
                    system: {
                        cpu_usage: "Offline",
                        memory_usage: "Offline",
                        disk_space: "Offline"
                    }
                };
                if (callback) callback(fallbackStatus);
            }
            
            if (errorCallback) errorCallback(error);
        });
}

// POST API call function
function apiPost(endpoint, data, callback, errorCallback) {
    fetch('/api/' + endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data || {})
    })
    .then(response => response.json())
    .then(result => {
        addDebugLog('✅ POST SUCCESS: ' + endpoint);
        if (callback) callback(result);
    })
    .catch(error => {
        addDebugLog('❌ POST ERROR: ' + endpoint + ' - ' + error.message);
        console.error('API POST Error:', endpoint, error);
        if (errorCallback) errorCallback(error);
    });
}

// Update System Overview with real data
function updateSystemOverview(data) {
    try {
        if (data.trading_bot) {
            // Update system status with actual trading mode
            var statusEl = document.querySelector('#section-overview .status-indicator');
            if (statusEl && data.trading_bot.trading_mode) {
                var isLiveTrading = !data.trading_bot.debug_mode;
                statusEl.textContent = data.trading_bot.trading_mode.toUpperCase();
                statusEl.className = 'status-indicator ' + 
                    (isLiveTrading ? 'status-live' : 'status-paper');
                
                // Update the main title based on mode
                var titleEl = document.querySelector('#section-overview h3');
                if (titleEl) {
                    titleEl.textContent = '🚀 Open Alpha Trading System (' + data.trading_bot.trading_mode + ')';
                }
            }
            
            // Update info boxes with real data (FIXED SELECTORS)
            var strategiesEl = document.querySelector('[data-metric="strategies"]');
            if (strategiesEl) strategiesEl.textContent = data.trading_bot.strategies_active || '0';
            
            var portfolioEl = document.querySelector('[data-metric="portfolio"]');
            if (portfolioEl) {
                // Show actual balance or indicate if not available
                var balanceText = data.trading_bot.balance;
                if (balanceText === "Initializing..." || balanceText === "Calculating...") {
                    portfolioEl.textContent = balanceText;
                } else {
                    portfolioEl.textContent = balanceText || 'No Data';
                }
            }
            
            var positionsEl = document.querySelector('[data-metric="positions"]');
            if (positionsEl) positionsEl.textContent = data.trading_bot.positions || '0';
            
            var pnlEl = document.querySelector('[data-metric="pnl"]');
            if (pnlEl) {
                var pnlText = data.trading_bot.daily_pnl;
                if (pnlText === "Calculating...") {
                    pnlEl.textContent = pnlText;
                } else {
                    pnlEl.textContent = pnlText || '$0.00';
                }
            }
        }
        
        if (data.system) {
            // Update system metrics
            var cpuEl = document.querySelector('[data-metric="cpu"]');
            if (cpuEl) cpuEl.textContent = 'CPU: ' + (data.system.cpu_usage || '0%');
            
            var memoryEl = document.querySelector('[data-metric="memory"]');
            if (memoryEl) memoryEl.textContent = 'Memory: ' + (data.system.memory_usage || '0%');
            
            var diskEl = document.querySelector('[data-metric="disk"]');
            if (diskEl) diskEl.textContent = 'Disk: ' + (data.system.disk_space || '100% available');
        }
        
        console.log('✅ OVERVIEW: Updated with live data');
        addDebugLog('✅ OVERVIEW: Live data refresh completed');
        
    } catch (error) {
        console.error('Overview update error:', error);
        addDebugLog('❌ OVERVIEW: Update error - ' + error.message);
    }
}

// Update Live Trading section with positions
function updateLiveTrading(positions) {
    try {
        var tbody = document.querySelector('#section-trading table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = ''; // Clear existing rows
        
        if (positions && positions.length > 0) {
            positions.forEach(position => {
                var row = document.createElement('tr');
                var sideClass = position.side === 'long' ? 'text-success' : 'text-danger';
                var pnlClass = parseFloat(position.pnl || 0) >= 0 ? 'text-success' : 'text-danger';
                
                row.innerHTML = `
                    <td>${position.symbol || 'N/A'}</td>
                    <td class="${sideClass}">${(position.side || 'UNKNOWN').toUpperCase()}</td>
                    <td>${position.size || '0'}</td>
                    <td>$${position.entry_price || '0.00'}</td>
                    <td>$${position.current_price || '0.00'}</td>
                    <td class="${pnlClass}">${position.pnl >= 0 ? '+' : ''}$${position.pnl || '0.00'}</td>
                `;
                tbody.appendChild(row);
            });
            
            addDebugLog('✅ TRADING: Updated ' + positions.length + ' positions');
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No active positions</td></tr>';
            addDebugLog('ℹ️ TRADING: No active positions');
        }
        
    } catch (error) {
        console.error('Trading update error:', error);
        addDebugLog('❌ TRADING: Update error - ' + error.message);
    }
}

// Emergency Controls
function emergencyStop() {
    if (confirm('⚠️ EMERGENCY STOP: This will immediately stop all trading. Continue?')) {
        addDebugLog('🚨 EMERGENCY: Stopping all trading...');
        apiPost('emergency-stop', {}, function(result) {
            addDebugLog('🚨 EMERGENCY: All trading stopped');
            alert('✅ Emergency stop completed');
            refreshData(); // Refresh data to show new status
        }, function(error) {
            addDebugLog('❌ EMERGENCY: Stop failed - ' + error.message);
            alert('❌ Emergency stop failed: ' + error.message);
        });
    }
}

function pauseTrading() {
    addDebugLog('⏸️ CONTROL: Pausing trading...');
    apiPost('pause', {}, function(result) {
        addDebugLog('⏸️ CONTROL: Trading paused');
        alert('⏸️ Trading paused');
        refreshData();
    }, function(error) {
        addDebugLog('❌ CONTROL: Pause failed - ' + error.message);
        alert('❌ Pause failed: ' + error.message);
    });
}

function resumeTrading() {
    addDebugLog('▶️ CONTROL: Resuming trading...');
    apiPost('resume', {}, function(result) {
        addDebugLog('▶️ CONTROL: Trading resumed');
        alert('▶️ Trading resumed');
        refreshData();
    }, function(error) {
        addDebugLog('❌ CONTROL: Resume failed - ' + error.message);
        alert('❌ Resume failed: ' + error.message);
    });
}

// Data refresh function
function refreshData() {
    addDebugLog('🔄 REFRESH: Loading live data...');
    
    // Get system status
    apiCall('status', function(data) {
        apiData.system = data;
        updateSystemOverview(data);
    });
    
    // Get positions
    apiCall('positions', function(data) {
        apiData.positions = data;
        updateLiveTrading(data);
    });
    
    // Get balance info
    apiCall('multi-balance', function(data) {
        apiData.balance = data;
        // Update portfolio section if needed
    });
    
    apiData.lastUpdate = new Date().toLocaleTimeString();
    addDebugLog('🔄 REFRESH: Completed at ' + apiData.lastUpdate);
}

// Auto-refresh every 5 seconds
var refreshInterval;

function startAutoRefresh() {
    refreshInterval = setInterval(refreshData, 5000);
    addDebugLog('🔄 AUTO-REFRESH: Started (5 second intervals)');
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        addDebugLog('⏹️ AUTO-REFRESH: Stopped');
    }
}

// CONSOLIDATED INITIALIZATION - Single DOMContentLoaded listener
document.addEventListener('DOMContentLoaded', function() {
    console.log('� DASHBOARD: Initializing complete system...');
    addDebugLog('🚀 SYSTEM: Initializing dashboard...');
    
    // Initialize dashboard navigation
    switchSection('overview');
    addDebugLog('✅ SYSTEM: Dashboard ready');
    
    // Initialize API integration
    console.log('�🔌 API INTEGRATION: Initializing...');
    addDebugLog('🔌 API: Initializing backend integration...');
    
    // Initial data load
    setTimeout(refreshData, 1000); // Wait 1 second for UI to settle
    
    // Start auto-refresh
    setTimeout(startAutoRefresh, 2000); // Start auto-refresh after 2 seconds
    
    console.log('✅ DASHBOARD: Complete system ready');
    addDebugLog('✅ API: Backend integration ready');
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// Fallback mode for when backend is unavailable
function showFallbackMode(failedEndpoint) {
    addDebugLog('🔄 FALLBACK: Backend unavailable, showing offline mode');
    
    if (failedEndpoint === 'status') {
        // Update system overview with fallback data
        var statusEl = document.querySelector('#section-overview .status-indicator');
        if (statusEl) {
            statusEl.textContent = 'BACKEND OFFLINE';
            statusEl.className = 'status-indicator status-inactive';
        }
        
        // Update title
        var titleEl = document.querySelector('#section-overview h3');
        if (titleEl) {
            titleEl.textContent = '🚀 Open Alpha Trading System (Offline Mode)';
        }
        
        // Update metrics with offline status
        var strategiesEl = document.querySelector('[data-metric="strategies"] .info-box-number');
        if (strategiesEl) strategiesEl.textContent = 'Offline';
        
        var portfolioEl = document.querySelector('[data-metric="portfolio"] .info-box-number');
        if (portfolioEl) portfolioEl.textContent = 'Offline';
        
        var positionsEl = document.querySelector('[data-metric="positions"] .info-box-number');
        if (positionsEl) positionsEl.textContent = 'Offline';
        
        var pnlEl = document.querySelector('[data-metric="pnl"] .info-box-number');
        if (pnlEl) pnlEl.textContent = 'Offline';
        
        // Update system metrics
        var cpuEl = document.querySelector('[data-metric="cpu"]');
        if (cpuEl) cpuEl.textContent = 'CPU: Backend Offline';
        
        var memoryEl = document.querySelector('[data-metric="memory"]');
        if (memoryEl) memoryEl.textContent = 'Memory: Backend Offline';
        
        var diskEl = document.querySelector('[data-metric="disk"]');
        if (diskEl) diskEl.textContent = 'Disk: Backend Offline';
    }
    
    if (failedEndpoint === 'positions') {
        // Update positions table
        var tbody = document.querySelector('#section-trading table tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Backend offline - Cannot load positions</td></tr>';
        }
    }
}

// Test backend connectivity
function testBackendConnection() {
    addDebugLog('🔍 CONNECTIVITY: Testing backend connection...');
    
    // Simple fetch to test if backend is responding
    fetch('/api/status')
        .then(response => {
            if (response.ok) {
                addDebugLog('✅ CONNECTIVITY: Backend is online');
                return true;
            } else {
                addDebugLog('❌ CONNECTIVITY: Backend returned error ' + response.status);
                return false;
            }
        })
        .catch(error => {
            addDebugLog('❌ CONNECTIVITY: Backend is offline - ' + error.message);
            showFallbackMode('status');
            return false;
        });
}

console.log('✅ API INTEGRATION: Script loaded');
</script>

</body>
</html>