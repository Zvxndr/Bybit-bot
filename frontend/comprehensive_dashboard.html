<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingBot Pro - Complete Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #206bc4;
            --success-color: #2fb344;
            --danger-color: #d63384;
            --warning-color: #fd7e14;
            --info-color: #17a2b8;
            --dark-bg: #151f2c;
            --card-bg: #1e2832;
        }

        body {
            background-color: var(--dark-bg);
            color: #ffffff;
        }

        .navbar {
            background-color: var(--card-bg) !important;
            border-bottom: 1px solid #374151;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid #374151;
            color: #ffffff;
        }

        .card-header {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid #374151;
        }

        /* System Status Banner */
        .system-status-banner {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .system-status-banner.live {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        }

        .status-indicator {
            font-size: 24px;
            margin-right: 15px;
        }

        .status-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .status-subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* Quick Stats Cards */
        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .stat-change {
            font-size: 0.8em;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Pipeline Stages */
        .pipeline-stage {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #374151;
        }

        .pipeline-stage.discovery {
            border-color: var(--info-color);
            background: rgba(23, 162, 184, 0.1);
        }

        .pipeline-stage.paper {
            border-color: var(--warning-color);
            background: rgba(253, 126, 20, 0.1);
        }

        .pipeline-stage.live {
            border-color: var(--success-color);
            background: rgba(47, 179, 68, 0.1);
        }

        .stage-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stage-count {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stage-label {
            color: #9ca3af;
            font-size: 0.9em;
        }

        /* Strategy Cards */
        .strategy-card {
            background: var(--card-bg);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .strategy-card.discovery {
            border-left: 4px solid var(--info-color);
        }

        .strategy-card.paper {
            border-left: 4px solid var(--warning-color);
        }

        .strategy-card.live {
            border-left: 4px solid var(--success-color);
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .strategy-id {
            font-weight: bold;
            font-size: 1.1em;
        }

        .strategy-phase {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .strategy-phase.discovery {
            background: var(--info-color);
            color: white;
        }

        .strategy-phase.paper {
            background: var(--warning-color);
            color: white;
        }

        .strategy-phase.live {
            background: var(--success-color);
            color: white;
        }

        .strategy-metrics {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .strategy-metrics .metric {
            text-align: center;
        }

        .strategy-metrics .metric span {
            display: block;
            color: #9ca3af;
            font-size: 0.8em;
        }

        .strategy-metrics .metric strong {
            display: block;
            font-size: 1.1em;
        }

        /* Performance Table */
        .performance-table {
            width: 100%;
        }

        .performance-table th,
        .performance-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #374151;
        }

        .performance-table th {
            background: rgba(255, 255, 255, 0.05);
            color: #9ca3af;
            font-weight: 600;
        }

        .profit {
            color: var(--success-color);
        }

        .loss {
            color: var(--danger-color);
        }

        /* Positions Table */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th,
        .positions-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #374151;
            font-size: 0.9em;
        }

        .positions-table th {
            color: var(--success-color);
            font-weight: bold;
        }

        /* Navigation Tabs */
        .nav-tabs .nav-link {
            color: #9ca3af;
            border: none;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background: rgba(32, 107, 196, 0.1);
            border-bottom: 2px solid var(--primary-color);
        }

        /* Backtesting Options */
        .option-card {
            border: 2px solid #374151;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: var(--primary-color);
            background: rgba(32, 107, 196, 0.1);
        }

        .option-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .option-subtitle {
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .option-desc {
            color: #9ca3af;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .d-none-mobile {
                display: none !important;
            }
            
            .strategy-metrics {
                flex-direction: column;
            }
            
            .strategy-metrics .metric {
                margin-bottom: 10px;
            }
        }

        /* Scrollable sections */
        .strategy-column {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">ü§ñ TradingBot Pro</span>
            <div class="d-flex">
                <span class="badge bg-success me-2" id="connectionStatus">Connected</span>
                <span class="text-muted" id="lastUpdate">--:--</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <!-- System Status Banner -->
        <div class="system-status-banner" id="systemStatusBanner">
            <div class="status-indicator" id="statusIcon">üõë</div>
            <div class="status-content">
                <div class="status-title" id="statusTitle">SAFE MODE - LIVE TRADING DISABLED</div>
                <div class="status-subtitle" id="statusSubtitle">Production Environment: Real API with Safety Controls</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">üìä Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#pipeline" data-bs-toggle="tab">ü§ñ AI Pipeline</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#backtesting" data-bs-toggle="tab">üß™ Backtesting</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#performance" data-bs-toggle="tab">üìà Performance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#settings" data-bs-toggle="tab">‚öôÔ∏è Settings</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
                <!-- Quick Stats Grid -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="stat-icon">üí∞</div>
                                <div class="stat-value" id="portfolioValue">$0</div>
                                <div class="stat-label">Portfolio Value</div>
                                <div class="stat-change positive" id="portfolioChange">+0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="stat-icon">ü§ñ</div>
                                <div class="stat-value" id="activeStrategies">0</div>
                                <div class="stat-label">Active Strategies</div>
                                <div class="stat-subtitle" id="strategiesBreakdown">0 paper, 0 live</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="stat-icon">üìà</div>
                                <div class="stat-value" id="todayPnl">$0</div>
                                <div class="stat-label">Today's P&L</div>
                                <div class="stat-change positive" id="todayChange">+0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="stat-icon">‚ö°</div>
                                <div class="stat-value" id="riskLevel">Low</div>
                                <div class="stat-label">Risk Level</div>
                                <div class="stat-subtitle" id="riskAllocation">0% allocated</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Pipeline Summary -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pipeline Summary</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-4">
                                        <div class="pipeline-stage discovery">
                                            <div class="stage-icon">üîç</div>
                                            <div class="stage-count" id="discoveryCount">0</div>
                                            <div class="stage-label">Discovery</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="pipeline-stage paper">
                                            <div class="stage-icon">üìù</div>
                                            <div class="stage-count" id="paperCount">0</div>
                                            <div class="stage-label">Paper Trading</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="pipeline-stage live">
                                            <div class="stage-icon">üöÄ</div>
                                            <div class="stage-count" id="liveCount">0</div>
                                            <div class="stage-label">Live Trading</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="col-lg-5 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Portfolio Performance</h3>
                                <div class="card-actions">
                                    <select class="form-select form-select-sm" id="performanceTimeframe">
                                        <option value="7d">7 Days</option>
                                        <option value="30d" selected>30 Days</option>
                                        <option value="90d">90 Days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="performanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="col-lg-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Activity</h3>
                            </div>
                            <div class="card-body">
                                <div class="activity-feed" id="activityFeed">
                                    <p class="text-muted">No recent activity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Positions -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Active Positions</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPositions()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="positionsContainer">
                                    <p class="text-muted">No active positions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Pipeline Tab -->
            <div class="tab-pane fade" id="pipeline">
                <div class="row">
                    <!-- Discovery Column -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üîç Discovery Phase</h3>
                                <span class="badge bg-info" id="discoveryBadge">0</span>
                            </div>
                            <div class="card-body strategy-column" id="discoveryStrategies">
                                <p class="text-muted">No strategies in discovery</p>
                            </div>
                        </div>
                    </div>

                    <!-- Paper Trading Column -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìù Paper Trading</h3>
                                <span class="badge bg-warning" id="paperBadge">0</span>
                            </div>
                            <div class="card-body strategy-column" id="paperStrategies">
                                <p class="text-muted">No strategies in paper trading</p>
                            </div>
                        </div>
                    </div>

                    <!-- Live Trading Column -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üöÄ Live Trading</h3>
                                <span class="badge bg-success" id="liveBadge">0</span>
                            </div>
                            <div class="card-body strategy-column" id="liveStrategies">
                                <p class="text-muted">No live strategies</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtesting Tab -->
            <div class="tab-pane fade" id="backtesting">
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Quick Backtest Setup</h3>
                            </div>
                            <div class="card-body">
                                <!-- Step 1: Trading Pairs -->
                                <h5>Step 1: Select Trading Pairs</h5>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="checkbox" name="pairs" value="BTCUSDT" checked>
                                            <div class="option-title">BTC/USDT</div>
                                            <div class="option-subtitle">Most Liquid</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="checkbox" name="pairs" value="ETHUSDT">
                                            <div class="option-title">ETH/USDT</div>
                                            <div class="option-subtitle">High Volume</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="checkbox" name="pairs" value="ADAUSDT">
                                            <div class="option-title">ADA/USDT</div>
                                            <div class="option-subtitle">Altcoin</div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Step 2: Timeframe -->
                                <h5>Step 2: Choose Timeframe</h5>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="radio" name="timeframe" value="1h">
                                            <div class="option-title">1 Hour</div>
                                            <div class="option-subtitle">Faster Testing</div>
                                            <div class="option-desc">Good for initial discovery</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="radio" name="timeframe" value="4h" checked>
                                            <div class="option-title">4 Hour</div>
                                            <div class="option-subtitle">Balanced</div>
                                            <div class="option-desc">Recommended starting point</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="option-card">
                                            <input type="radio" name="timeframe" value="1d">
                                            <div class="option-title">1 Day</div>
                                            <div class="option-subtitle">Portfolio Analysis</div>
                                            <div class="option-desc">Long-term strategy testing</div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Step 3: Performance Targets -->
                                <h5>Step 3: Set Performance Targets</h5>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Minimum Sharpe Ratio</label>
                                        <input type="number" class="form-control" value="1.5" step="0.1">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Maximum Drawdown (%)</label>
                                        <input type="number" class="form-control" value="15" step="1">
                                    </div>
                                </div>

                                <button class="btn btn-primary" onclick="startBacktest()">
                                    <i class="bi bi-play-fill"></i> Start Backtest
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Active Jobs -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Active Jobs</h3>
                            </div>
                            <div class="card-body">
                                <div id="backtestJobs">
                                    <p class="text-muted">No active backtests</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-pane fade" id="performance">
                <div class="row">
                    <!-- Portfolio Performance Chart -->
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Portfolio Performance</h3>
                                <div class="card-actions">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-secondary active" data-range="7d">7D</button>
                                        <button class="btn btn-sm btn-outline-secondary" data-range="30d">30D</button>
                                        <button class="btn btn-sm btn-outline-secondary" data-range="90d">90D</button>
                                        <button class="btn btn-sm btn-outline-secondary" data-range="1y">1Y</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="portfolioChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Performance Metrics</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="totalReturn">+0%</div>
                                        <div class="stat-label">Total Return</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="sharpeRatio">0.0</div>
                                        <div class="stat-label">Sharpe Ratio</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="maxDrawdown">0%</div>
                                        <div class="stat-label">Max Drawdown</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="winRate">0%</div>
                                        <div class="stat-label">Win Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Performance Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Strategy Performance</h3>
                            </div>
                            <div class="card-body">
                                <table class="table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Status</th>
                                            <th>Allocation</th>
                                            <th>P&L</th>
                                            <th>Sharpe</th>
                                            <th>Max DD</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategyPerformanceTable">
                                        <tr>
                                            <td colspan="7" class="text-muted text-center">No strategies to display</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings">
                <div class="row">
                    <!-- Emergency Controls -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title text-danger">Emergency Controls</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="liveTradingToggle" class="form-check-input me-2">
                                        Enable Live Trading
                                    </label>
                                    <div class="text-muted small">Live trading is disabled by default for safety</div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-danger" onclick="emergencyStop()">
                                        <i class="bi bi-stop-fill"></i> Emergency Stop All Trading
                                    </button>
                                    <button class="btn btn-warning" onclick="pauseAllStrategies()">
                                        <i class="bi bi-pause-fill"></i> Pause All Strategies
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Status -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">API Status</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="apiStatus">Connected</div>
                                        <div class="stat-label">Bybit API</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="apiEnvironment">Mainnet</div>
                                        <div class="stat-label">Environment</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="apiCalls">0</div>
                                        <div class="stat-label">API Calls Today</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-value" id="systemUptime">0h 0m</div>
                                        <div class="stat-label">System Uptime</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Configuration -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">System Configuration</h3>
                            </div>
                            <div class="card-body">
                                <form id="settingsForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Max Daily Risk (%)</label>
                                            <input type="number" class="form-control" id="maxDailyRisk" value="2" step="0.1">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Max Position Size (%)</label>
                                            <input type="number" class="form-control" id="maxPositionSize" value="10" step="1">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Stop Loss (%)</label>
                                            <input type="number" class="form-control" id="stopLoss" value="5" step="0.1">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Take Profit (%)</label>
                                            <input type="number" class="form-control" id="takeProfit" value="15" step="0.1">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        class ComprehensiveTradingDashboard {
            constructor() {
                this.apiBase = window.location.origin + '/api';
                this.wsConnection = null;
                this.isLiveTrading = false;
                this.charts = {};
                this.updateInterval = 15000; // 15 seconds
                
                this.init();
            }
            
            async init() {
                console.log('üöÄ Initializing Comprehensive Trading Dashboard...');
                
                // Initialize charts
                this.initializeCharts();
                
                // Load initial data
                await this.loadAllData();
                
                // Setup WebSocket
                this.setupWebSocket();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Start update cycle
                setInterval(() => this.loadAllData(), this.updateInterval);
                
                console.log('‚úÖ Comprehensive Trading Dashboard Ready');
            }
            
            async loadAllData() {
                try {
                    const [portfolio, status, metrics, riskData, opportunities, strategies] = await Promise.all([
                        this.apiCall('/portfolio'),
                        this.apiCall('/status'),
                        this.apiCall('/metrics'),
                        this.apiCall('/risk-metrics'),
                        this.apiCall('/opportunities'),
                        this.apiCall('/strategies')
                    ]);
                    
                    this.updateDashboard(portfolio, status, metrics, riskData);
                    this.updateSystemStatus(status);
                    this.updatePipeline(strategies);
                    this.updatePerformanceTab(portfolio);
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    
                } catch (error) {
                    console.error('‚ùå Failed to load data:', error);
                    this.showConnectionError();
                }
            }
            
            updateDashboard(portfolio, status, metrics, riskData) {
                // Update quick stats
                document.getElementById('portfolioValue').textContent = `$${this.formatNumber(portfolio.total_balance)}`;
                document.getElementById('todayPnl').textContent = `$${this.formatNumber(portfolio.unrealized_pnl)}`;
                document.getElementById('riskLevel').textContent = this.capitalizeFirst(riskData.current_risk_level);
                
                // Update system status banner
                const banner = document.getElementById('systemStatusBanner');
                const icon = document.getElementById('statusIcon');
                const title = document.getElementById('statusTitle');
                
                if (this.isLiveTrading && status.api_connected) {
                    banner.className = 'system-status-banner live';
                    icon.textContent = 'üöÄ';
                    title.textContent = 'LIVE TRADING ACTIVE';
                } else {
                    banner.className = 'system-status-banner';
                    icon.textContent = 'üõ°Ô∏è';
                    title.textContent = 'SAFE MODE - LIVE TRADING DISABLED';
                }
                
                // Update pipeline summary
                document.getElementById('discoveryCount').textContent = '0'; // Would come from strategies API
                document.getElementById('paperCount').textContent = '0';
                document.getElementById('liveCount').textContent = '0';
                
                // Update positions table
                this.updatePositionsTable(portfolio.positions || []);
            }
            
            updateSystemStatus(status) {
                const connectionBadge = document.getElementById('connectionStatus');
                
                if (status.api_connected) {
                    connectionBadge.className = 'badge bg-success me-2';
                    connectionBadge.textContent = 'Connected';
                } else {
                    connectionBadge.className = 'badge bg-danger me-2';
                    connectionBadge.textContent = 'Disconnected';
                }
                
                // Update settings tab
                document.getElementById('apiStatus').textContent = status.api_connected ? 'Connected' : 'Disconnected';
                document.getElementById('apiEnvironment').textContent = this.capitalizeFirst(status.environment);
            }
            
            updatePipeline(strategies) {
                // This would be populated with real strategy data
                // For now, showing placeholders
                
                const discoveryContainer = document.getElementById('discoveryStrategies');
                const paperContainer = document.getElementById('paperStrategies');
                const liveContainer = document.getElementById('liveStrategies');
                
                // Update strategy counts in badges
                document.getElementById('discoveryBadge').textContent = '0';
                document.getElementById('paperBadge').textContent = '0';
                document.getElementById('liveBadge').textContent = '0';
                
                // Would populate with real strategy cards
            }
            
            updatePerformanceTab(portfolio) {
                // Update performance metrics
                document.getElementById('totalReturn').textContent = '+0%'; // Calculate from historical data
                document.getElementById('sharpeRatio').textContent = '0.0';
                document.getElementById('maxDrawdown').textContent = '0%';
                document.getElementById('winRate').textContent = '0%';
            }
            
            updatePositionsTable(positions) {
                const container = document.getElementById('positionsContainer');
                
                if (!positions || positions.length === 0) {
                    container.innerHTML = '<p class="text-muted">No active positions</p>';
                    return;
                }
                
                let table = `
                    <table class="table positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Size</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>P&L</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                positions.forEach(position => {
                    const pnl = parseFloat(position.unrealized_pnl || 0);
                    const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                    
                    table += `
                        <tr>
                            <td><strong>${position.symbol}</strong></td>
                            <td><span class="badge bg-${position.side === 'Buy' ? 'success' : 'danger'}">${position.side}</span></td>
                            <td>${position.size}</td>
                            <td>$${this.formatNumber(position.entry_price || 0)}</td>
                            <td>$${this.formatNumber(position.current_price || 0)}</td>
                            <td class="${pnlClass}">$${this.formatNumber(pnl)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="closePosition('${position.symbol}')">Close</button>
                            </td>
                        </tr>
                    `;
                });
                
                table += '</tbody></table>';
                container.innerHTML = table;
            }
            
            initializeCharts() {
                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart');
                if (performanceCtx) {
                    this.charts.performance = new Chart(performanceCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Portfolio Value',
                                data: [],
                                borderColor: '#2fb344',
                                backgroundColor: 'rgba(47, 179, 68, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: false,
                                    grid: { color: '#374151' }
                                },
                                x: { 
                                    grid: { color: '#374151' }
                                }
                            }
                        }
                    });
                }
                
                // Portfolio Chart
                const portfolioCtx = document.getElementById('portfolioChart');
                if (portfolioCtx) {
                    this.charts.portfolio = new Chart(portfolioCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Portfolio Performance',
                                data: [],
                                borderColor: '#206bc4',
                                backgroundColor: 'rgba(32, 107, 196, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: false,
                                    grid: { color: '#374151' }
                                },
                                x: { 
                                    grid: { color: '#374151' }
                                }
                            }
                        }
                    });
                }
            }
            
            setupWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                try {
                    this.wsConnection = new WebSocket(wsUrl);
                    
                    this.wsConnection.onopen = () => {
                        console.log('üîå WebSocket connected');
                        document.getElementById('connectionStatus').textContent = 'Connected';
                        document.getElementById('connectionStatus').className = 'badge bg-success me-2';
                    };
                    
                    this.wsConnection.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'dashboard_update') {
                            this.handleRealtimeUpdate(data);
                        }
                    };
                    
                    this.wsConnection.onclose = () => {
                        console.log('üîå WebSocket disconnected');
                        document.getElementById('connectionStatus').textContent = 'Disconnected';
                        document.getElementById('connectionStatus').className = 'badge bg-warning me-2';
                        
                        // Reconnect after 5 seconds
                        setTimeout(() => this.setupWebSocket(), 5000);
                    };
                    
                } catch (error) {
                    console.error('‚ùå WebSocket setup failed:', error);
                }
            }
            
            setupEventListeners() {
                // Live trading toggle
                const liveTradingToggle = document.getElementById('liveTradingToggle');
                if (liveTradingToggle) {
                    liveTradingToggle.addEventListener('change', async (e) => {
                        const enabled = e.target.checked;
                        
                        try {
                            const result = await this.apiCall('/settings', {
                                method: 'POST',
                                body: JSON.stringify({ live_trading_enabled: enabled })
                            });
                            
                            if (result.success) {
                                this.isLiveTrading = enabled;
                                this.showAlert(
                                    enabled ? '‚ö†Ô∏è LIVE TRADING ENABLED! Real money at risk.' : 'Live trading disabled. Safe mode active.',
                                    enabled ? 'warning' : 'success'
                                );
                            } else {
                                e.target.checked = !enabled;
                                this.showAlert(result.error || 'Failed to update settings', 'danger');
                            }
                        } catch (error) {
                            console.error('Settings update error:', error);
                            e.target.checked = !enabled;
                            this.showAlert('Failed to communicate with server', 'danger');
                        }
                    });
                }
                
                // Settings form
                const settingsForm = document.getElementById('settingsForm');
                if (settingsForm) {
                    settingsForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.saveSettings();
                    });
                }
            }
            
            async saveSettings() {
                const settings = {
                    max_daily_risk: document.getElementById('maxDailyRisk').value,
                    max_position_size: document.getElementById('maxPositionSize').value,
                    stop_loss: document.getElementById('stopLoss').value,
                    take_profit: document.getElementById('takeProfit').value
                };
                
                try {
                    const result = await this.apiCall('/settings', {
                        method: 'POST',
                        body: JSON.stringify(settings)
                    });
                    
                    if (result.success) {
                        this.showAlert('Settings saved successfully', 'success');
                    } else {
                        this.showAlert('Failed to save settings', 'danger');
                    }
                } catch (error) {
                    console.error('Save settings error:', error);
                    this.showAlert('Failed to save settings', 'danger');
                }
            }
            
            handleRealtimeUpdate(data) {
                if (data.portfolio) {
                    document.getElementById('portfolioValue').textContent = `$${this.formatNumber(data.portfolio.total_balance)}`;
                    document.getElementById('todayPnl').textContent = `$${this.formatNumber(data.portfolio.unrealized_pnl)}`;
                }
                
                if (data.risk_metrics) {
                    document.getElementById('riskLevel').textContent = this.capitalizeFirst(data.risk_metrics.current_risk_level);
                }
            }
            
            showConnectionError() {
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('connectionStatus').className = 'badge bg-danger me-2';
            }
            
            showAlert(message, type = 'info') {
                // Create and show bootstrap alert
                const alertHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Insert at top of container
                const container = document.querySelector('.container-fluid');
                container.insertAdjacentHTML('afterbegin', alertHTML);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) alert.remove();
                }, 5000);
            }
            
            async apiCall(endpoint, options = {}) {
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };
                
                const response = await fetch(`${this.apiBase}${endpoint}`, config);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                return await response.json();
            }
            
            formatNumber(num) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num || 0);
            }
            
            capitalizeFirst(str) {
                return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
            }
        }
        
        // Global functions
        window.refreshPositions = async function() {
            if (window.dashboard) {
                await window.dashboard.loadAllData();
                window.dashboard.showAlert('Positions refreshed', 'success');
            }
        };
        
        window.emergencyStop = async function() {
            if (window.dashboard) {
                const toggle = document.getElementById('liveTradingToggle');
                if (toggle.checked) {
                    toggle.checked = false;
                    toggle.dispatchEvent(new Event('change'));
                }
                window.dashboard.showAlert('üõë EMERGENCY STOP ACTIVATED - All trading halted!', 'danger');
            }
        };
        
        window.pauseAllStrategies = function() {
            if (window.dashboard) {
                window.dashboard.showAlert('‚è∏Ô∏è All strategies paused', 'warning');
            }
        };
        
        window.startBacktest = function() {
            if (window.dashboard) {
                window.dashboard.showAlert('üß™ Backtest started', 'info');
            }
        };
        
        window.closePosition = function(symbol) {
            if (window.dashboard) {
                window.dashboard.showAlert(`Closing position for ${symbol}`, 'warning');
            }
        };
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new ComprehensiveTradingDashboard();
        });
    </script>
</body>
</html>